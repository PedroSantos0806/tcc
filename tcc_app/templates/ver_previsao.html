{% extends "base.html" %}
{% block content %}
<h1>{{ t('History and Forecast') }}</h1>

<div class="explicacao">
  <h3>{{ t('How we forecast?') }}</h3>
  <p>
    {{ t('History and Forecast') }}
  </p>
</div>

<form method="GET" class="form-box" id="filtroForm">
  <label for="categoria">{{ t('Filter by category:') }}</label>
  <select name="categoria" id="categoria" onchange="this.form.submit()">
    <option value="">{{ t('All (f)') }}</option>
    {% for cat in categorias %}
      <option value="{{ cat }}" {% if cat == categoria_selecionada %}selected{% endif %}>{{ cat }}</option>
    {% endfor %}
  </select>
</form>

<div class="cards-row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0;">
  <div class="card"><h3>Horizonte</h3><p>14 {{ t('Horizon (days)') }}</p></div>
  <div class="card"><h3>{{ t('Last day') }}</h3><p id="kpi-ult">—</p></div>
  <div class="card"><h3>{{ t('7-day avg') }}</h3><p id="kpi-ma7">—</p></div>
</div>

<canvas id="prevChart" height="180"></canvas>
<p id="msgSemDados" style="display:none;margin-top:10px;">{{ t('No data to predict') }}</p>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadPrev(){
  const params = new URLSearchParams(window.location.search);
  const cat = params.get('categoria') || '';
  const res = await fetch(`/api/previsao?categoria=${encodeURIComponent(cat)}`);
  const data = await res.json();

  const hasHist = (data.labels_hist && data.labels_hist.length > 0);
  if (!hasHist){
    document.getElementById('prevChart').style.display = 'none';
    document.getElementById('msgSemDados').style.display = 'block';
    return;
  }

  const ult = data.hist[data.hist.length-1];
  const ma7 = data.hist.slice(-7).reduce((a,b)=>a+(+b||0),0) / Math.min(7, data.hist.length);
  document.getElementById('kpi-ult').textContent = ult ?? 0;
  document.getElementById('kpi-ma7').textContent = (isFinite(ma7) ? ma7.toFixed(1) : '0.0');

  const ctx = document.getElementById('prevChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: [...data.labels_hist, ...data.labels_pred],
      datasets: [
        { label: 'Histórico (un)', data: [...data.hist, ...Array(data.pred.length).fill(null)], borderWidth: 2 },
        { label: 'Previsão (un)', data: [...Array(data.hist.length).fill(null), ...data.pred], borderDash:[6,6], borderWidth: 2 }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: '{{ t("History and Forecast") }}' },
        tooltip: { mode: 'index', intersect: false }
      },
      interaction: { mode: 'index', intersect: false },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });
}
document.addEventListener('DOMContentLoaded', loadPrev);
</script>
{% endblock %}
