{% extends "base.html" %}
{% block content %}

<section class="dashboard-shell page-dashboard">

  <header class="dash-header">
    <div class="dash-header-left">
      <h1 class="dash-title">{{ t('Dashboard') }}</h1>
      <p class="dash-subtitle">{{ t('Login subtitle') }}</p>
    </div>
    <div class="dash-header-right">
      <div class="dash-filter-group">
        <label for="filtro-categoria" class="dash-label">Categoria</label>
        <select id="filtro-categoria" class="dash-select">
          <option value="">{{ 'Todas as categorias' }}</option>
          {% for c in categorias %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <a href="{{ url_for('main_bp.cadastrar_venda') }}" class="btn dash-btn-primary">
        Registrar venda
      </a>
    </div>
  </header>

  <!-- KPIs principais -->
  <section class="kpi-grid dash-kpis">
    <article class="kpi-card dash-kpi-card">
      <div class="kpi-title">{{ t('Weekly sales') }}</div>
      <div class="kpi-value">{{ kpis.vendas_semana|fmt_int }}</div>
      <p class="kpi-caption">Vendas registradas na semana atual.</p>
    </article>

    <article class="kpi-card dash-kpi-card">
      <div class="kpi-title">{{ t('Weekly revenue') }}</div>
      <div class="kpi-value">{{ kpis.receita_semana|fmt_money }}</div>
      <p class="kpi-caption">Receita total considerando todos os produtos.</p>
    </article>

    <article class="kpi-card dash-kpi-card">
      <div class="kpi-title">{{ t('Low stock items') }}</div>
      <div class="kpi-value">{{ kpis.itens_baixo|fmt_int }}</div>
      <p class="kpi-caption">Itens que já estão próximos de acabar.</p>
    </article>

    <article class="kpi-card dash-kpi-card">
      <div class="kpi-title">{{ t('Out of stock items') }}</div>
      <div class="kpi-value">{{ kpis.itens_falta|fmt_int }}</div>
      <p class="kpi-caption">Produtos que estão sem estoque.</p>
    </article>
  </section>

  <!-- Grid principal: gráfico + previsão -->
  <section class="dash-main-grid">
    <article class="panel dash-panel">
      <header class="dash-panel-header">
        <div>
          <h3 class="dash-panel-title">Resumo de vendas e estoque</h3>
          <p class="dash-panel-subtitle">Quantidade vendida, estoque atual, custo e lucro por produto.</p>
        </div>
      </header>
      <div class="dash-panel-body">
        <canvas id="chart-dashboard"></canvas>
      </div>
    </article>

    <article class="panel dash-panel">
      <header class="dash-panel-header">
        <div>
          <h3 class="dash-panel-title">Previsão de demanda (14 dias)</h3>
          <p class="dash-panel-subtitle">Projeção de vendas diárias combinando tendência e sazonalidade.</p>
        </div>
      </header>
      <div class="dash-panel-body">
        <canvas id="chart-previsao"></canvas>
      </div>
    </article>
  </section>

  <!-- Segunda linha de cards: alertas e onboarding -->
  <section class="dash-bottom-grid">
    <article class="panel dash-panel">
      <header class="dash-panel-header">
        <div>
          <h3 class="dash-panel-title">{{ t('Stock alerts') }}</h3>
          <p class="dash-panel-subtitle">Produtos que merecem atenção especial.</p>
        </div>
      </header>
      <div class="dash-panel-body">
        <div class="dash-empty">
          <div class="emoji">⚠️</div>
          <p class="muted">{{ t('No suggestions now') }}</p>
        </div>
      </div>
    </article>

    <article class="panel dash-panel">
      <header class="dash-panel-header">
        <div>
          <h3 class="dash-panel-title">Comece configurando o PrevSuite</h3>
          <p class="dash-panel-subtitle">Cadastre produtos e registre vendas para liberar todo o potencial da IA.</p>
        </div>
      </header>
      <div class="dash-panel-body">
        <div class="dash-onboarding-actions">
          <a class="btn primary" href="{{ url_for('main_bp.cadastrar_produto') }}">Cadastrar produtos</a>
          <a class="btn" href="{{ url_for('main_bp.ver_estoque') }}">Gerenciar estoque</a>
          <a class="btn ghost" href="{{ url_for('main_bp.cadastrar_venda') }}">Registrar venda</a>
        </div>
      </div>
    </article>
  </section>

</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const catSelect = document.getElementById('filtro-categoria');
  const loadDash = async () => {
    const cat = catSelect.value || '';
    const res = await fetch(`/api/dashboard?categoria=${encodeURIComponent(cat)}`);
    const data = await res.json();
    const ctx = document.getElementById('chart-dashboard').getContext('2d');

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.labels,
        datasets: [
          { label: 'Vendidos', data: data.vendidos, borderWidth: 1 },
          { label: 'Em estoque', data: data.estoque, borderWidth: 1 },
          { label: 'Custo total', data: data.custo, borderWidth: 1 },
          { label: 'Lucro', data: data.lucro, borderWidth: 1 }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'top' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  };

  const loadPrev = async () => {
    const cat = catSelect.value || '';
    const res = await fetch(`/api/previsao?categoria=${encodeURIComponent(cat)}`);
    const data = await res.json();
    const ctx = document.getElementById('chart-previsao').getContext('2d');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: [...data.labels_hist, ...data.labels_pred],
        datasets: [
          { label: 'Histórico', data: [...data.hist, ...Array(data.pred.length).fill(null)], borderWidth: 2 },
          { label: 'Previsão', data: [...Array(data.hist.length).fill(null), ...data.pred], borderWidth: 2, borderDash:[6,6] }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' }
        },
        scales: { y: { beginAtZero: true } }
      }
    });
  };

  catSelect.addEventListener('change', () => { loadDash(); loadPrev(); });
  loadDash();
  loadPrev();
});
</script>

{% endblock %}
