{% extends "base.html" %}
{% block content %}
<h1>Dashboard Geral</h1>

<div class="explicacao">
  <h3>O que estou vendo?</h3>
  <p>
    Este gráfico resume por produto: <strong>Vendido</strong>, <strong>Em Estoque</strong> (= inicial − vendidos),
    <strong>Custo Total</strong> (vendido × custo) e <strong>Lucro</strong> (receita − custo).
    Usa dados do <strong>Banco</strong> e, quando existir, complementa com os <strong>CSVs</strong> do protótipo.
  </p>
</div>

<form method="GET" class="form-box">
  <label for="categoria">Filtrar por categoria:</label>
  <select name="categoria" id="categoria" onchange="this.form.submit()">
      <option value="">Todas</option>
      {% for cat in categorias %}
      <option value="{{ cat }}" {% if cat == categoria_selecionada %}selected{% endif %}>{{ cat }}</option>
      {% endfor %}
  </select>
</form>

<canvas id="grafico" height="200"></canvas>
<p id="msgDashVazio" style="display:none;margin-top:10px;">Sem dados para montar o dashboard.</p>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadDash(){
  const params = new URLSearchParams(window.location.search);
  const cat = params.get('categoria') || '';
  const res = await fetch(`/api/dashboard?categoria=${encodeURIComponent(cat)}`);
  const data = await res.json();

  if (!data.labels || data.labels.length === 0){
    document.getElementById('grafico').style.display = 'none';
    document.getElementById('msgDashVazio').style.display = 'block';
    return;
  }

  const ctx = document.getElementById('grafico').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.labels,
      datasets: [
        { label: 'Vendido (un)', data: data.vendidos, backgroundColor: 'rgba(54,162,235,0.7)' },
        { label: 'Em Estoque (un)', data: data.estoque, backgroundColor: 'rgba(255,206,86,0.7)' },
        { label: 'Custo Total (R$)', data: data.custo, backgroundColor: 'rgba(255,99,132,0.7)' },
        { label: 'Lucro (R$)', data: data.lucro, backgroundColor: 'rgba(75,192,192,0.7)' }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Resumo por Produto (Banco + CSV)' },
        tooltip: {
          callbacks: {
            label: ctx => {
              const label = ctx.dataset.label || '';
              const val = ctx.parsed.y;
              if (label.includes('R$')) {
                return `${label}: ${val.toLocaleString('pt-BR', { style:'currency', currency:'BRL' })}`;
              }
              return `${label}: ${val}`;
            }
          }
        }
      },
      scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
  });
}
document.addEventListener('DOMContentLoaded', loadDash);
</script>
{% endblock %}
